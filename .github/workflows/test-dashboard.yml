name: Test ESPHome Dashboard

# Run this job on pull requests and pushes to main branch
on:
  push:
    branches:
      - main
      - master
  pull_request: {}

jobs:
  test-dashboard:
    if: contains(github.event.head_commit.message, '[skip ci]') == false

    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install ESPHome for testing
        run: |
          python -m pip install --upgrade pip
          pip install esphome pillow

      - name: Verify ESPHome installation
        run: |
          esphome version
          echo "ESPHome CLI is working"

      - name: Test Dashboard Startup (Direct ESPHome)
        timeout-minutes: 8
        run: |
          echo "Starting ESPHome Dashboard test..."
          node test/dashboard/test-dashboard-startup.js

      - name: Test Adapter Dashboard Integration (autopy)
        timeout-minutes: 5
        run: |
          echo "Testing dashboard with adapter-style configuration..."
          node test/dashboard/test-adapter-dashboard.js