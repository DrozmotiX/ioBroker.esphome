name: Test ESPHome Dashboard Integration

# Run this job on pull requests and pushes to main branch
on:
  push:
    branches:
      - main
      - master
  pull_request: {}

jobs:
  test-dashboard-integration:
    if: contains(github.event.head_commit.message, '[skip ci]') == false

    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install ESPHome for dashboard integration testing
        run: |
          python -m pip install --upgrade pip
          pip install esphome pillow || echo "ESPHome installation may fail in CI - integration test will handle gracefully"

      - name: Verify ESPHome installation
        continue-on-error: true
        run: |
          esphome version || echo "ESPHome CLI may not be available - test will handle gracefully"

      - name: Test Dashboard Integration with Adapter
        timeout-minutes: 15
        run: |
          echo "Testing adapter dashboard integration..."
          echo "This test verifies the adapter correctly processes dashboard configuration"
          npm run test:integration-dashboard